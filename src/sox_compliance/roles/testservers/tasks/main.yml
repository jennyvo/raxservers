---
- name: Test Server build requests
  local_action:    
    module: rax
    credentials: ~/.raxpub
    name: "{{ prefix }}-testserver%02d"
    flavor: "{{ flavor2 }}"
    image: "{{ image }}"
    files: "{{ files }}"
    region: "{{ region }}"
    state: present
    count: 2
    count_offset: 1
    exact_count: yes
    group: "{{ prefix }}-test_sox"
    wait: yes
    wait_timeout: 3000
  register: testcs
  tags:
    - sox

#- name: gather serverid
#  set_fact:
#    servername: "{{ item.name }}"
#    serverid: "{{ item.id }}"
#    flavor: "{{ item.rax_flavor[\"id\"]}}"
#    servername: "{{ item.rax_name }}"
#    created: "{{ item.rax_created }}"
#    updated: "{{ item.rax_updated }}"
#  with_items: testcs.success
#  when: testcs.action == 'create'
#  register: serverids

#- name: make a list
#  set_fact:
#    list_id: "{{ serverids.results | map(attribute='ansible_facts.serverid') | list }}"

#- name: debug
#  debug: var=list_id

- name: delete serverid.txt to create new one
  local_action: 
    module: file
    path: ~/data/serverid.txt
    state: absent

- name: save server id to file
  local_action: 
    module: lineinfile
    create: yes
    dest: ~/data/serverid.txt
    line: "{{ item.id}}"
  with_items: testcs.success
  when: testcs.action == 'create'

- name: delete serverid.txt to create new one
  local_action:
    module: file
    path: ~/data/linkserver.txt
    state: absent

- name: save server id to file
  local_action:
    module: lineinfile
    create: yes
    dest: ~/data/linkserver.txt
    line: "{{ item.rax_links[0][\"href\"]}}"
  with_items: testcs.success
  when: testcs.action == 'create'

- name: gather info about server write to files (account, servername, serverid, flavor, created, updated, status)
  local_action:
    module: lineinfile
    create: yes
    dest: ~/data/serversinfo.csv
    insertafter: EOF
    line: "{{ item.rax_tenant_id }}, {{ item.rax_name }}, {{ item.id }}, {{ item.rax_flavor[\"id\"] }}, {{ item.rax_created }}, {{ item.rax_updated }}, {{ item.rax_status }}"
  with_items: testcs.success
  when: testcs.action == 'create'
 
#- name: debug
#  debug: var=item.stdout
#  with_items: testcs.result
